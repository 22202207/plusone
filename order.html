<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ご注文 | MyShop</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{font-family:sans-serif;padding:2rem;max-width:600px;margin:auto}
    .btn{padding:.6rem 1.2rem;background:#4f46e5;color:#fff;border:none;border-radius:4px;font-size:1rem;cursor:pointer}
  </style>
</head>
<body>
  <h1 id="name">商品名</h1>
  <p>価格: <span id="price">0</span> 円</p>
  <button id="buy" class="btn">支払いへ進む</button>

  <script>
    // ===== 必ず末尾 / を残す ====================
    const CHECKOUT_ENDPOINT = "https://plusone-api.08e2207.workers.dev/";
    // ==========================================

    // URL パラメータから商品名と価格を取得
    const params = new URLSearchParams(location.search);
    const product_name  = params.get("product_name");
    const product_price = params.get("product_price");

    if (!product_name || !product_price) {
      alert("URL に商品情報がありません");
      document.getElementById("buy").disabled = true;
    } else {
      document.getElementById("name").textContent  = product_name;
      document.getElementById("price").textContent = Number(product_price).toLocaleString();

      document.getElementById("buy").addEventListener("click", async () => {
        try {
          // Worker へセッション作成リクエスト
          const res = await fetch(CHECKOUT_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ product_name, product_price })
          });
          const { sessionId, error } = await res.json();
          if (!res.ok || !sessionId) throw error || "Session error";

          // Stripe にリダイレクト（公開キー不要）
          const stripe = Stripe("");        // 空文字で OK
          await stripe.redirectToCheckout({ sessionId });
        } catch (e) {
          console.error(e);
          alert("決済を開始できませんでした");
        }
      });
    }
  </script>
</body>
</html>


